<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari Fix –¥–ª—è Figma Sites</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .step {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-container {
            position: relative;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #2980b9;
        }
        
        .copy-btn:active {
            background: #21618c;
        }
        
        pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d5f4e6;
            border-left-color: #27ae60;
            color: #27ae60;
        }
        
        .warning {
            background: #fef9e7;
            border-left-color: #f39c12;
            color: #d68910;
        }
        
        .error {
            background: #fadbd8;
            border-left-color: #e74c3c;
            color: #c0392b;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .feature h4 {
            margin: 0 0 10px 0;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçé Safari Fix –¥–ª—è Figma Sites</h1>
        <p>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ iframe –≤ Safari –¥–ª—è Figma Sites.</p>
        
        <div class="step warning">
            <h3>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞</h3>
            <p>–í Safari iframe –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç —Ä–∞–∑–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑-–∑–∞ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏—Ö –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ä–∞–±–æ—Ç—ã —Å postMessage API.</p>
        </div>
        
        <div class="features">
            <div class="feature">
                <h4>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
                <ul>
                    <li>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Safari</li>
                    <li>–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ postMessage</li>
                    <li>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Å–æ—Ç—ã</li>
                    <li>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow</li>
                </ul>
            </div>
            <div class="feature">
                <h4>üîß –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</h4>
                <ul>
                    <li>Safari –Ω–∞ macOS</li>
                    <li>Safari –Ω–∞ iOS</li>
                    <li>WebKit –±—Ä–∞—É–∑–µ—Ä—ã</li>
                    <li>Figma Sites</li>
                </ul>
            </div>
        </div>
        
        <div class="step">
            <h3>üìã –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥</h3>
            <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Ä–∞–∑–¥–µ–ª "Custom Code" –≤–∞—à–µ–≥–æ Figma Sites –ø—Ä–æ–µ–∫—Ç–∞:</p>
        </div>
        
        <div class="code-container">
            <button class="copy-btn" onclick="copyCode()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <pre id="safari-code">// Safari iframe fix for Figma Sites - Production Ready
// Copy this entire script to your Figma Sites custom code section

(function() {
    'use strict';
    
    // Detect Safari and WebKit browsers
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isWebKit = /webkit/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent);
    
    if (!isSafari && !isWebKit) return; // Only run on Safari/WebKit
    
    console.log("üçé Safari iframe fix activated");
    
    const safariIframeManager = {
        processedIframes: new Set(),
        heightCache: new Map(),
        
        findIframeBySource(source) {
            const iframes = Array.from(document.querySelectorAll('iframe'));
            for (let iframe of iframes) {
                try {
                    const src = iframe.src || iframe.getAttribute('src') || '';
                    if (src.includes('support.html') && source === 'support-html') return iframe;
                    if (src.includes('tags.html') && source === 'tags-html') return iframe;
                    if (src.includes('design.html') && source === 'design-html') return iframe;
                    if (src.includes('something.html') && source === 'something-html') return iframe;
                } catch (e) {
                    // Ignore security errors
                }
            }
            return null;
        },
        
        setIframeHeight(iframe, height, source) {
            if (!iframe || height <= 0) return;
            
            const minHeight = 50;
            const maxHeight = Math.max(window.innerHeight * 3, 2000);
            const safeHeight = Math.max(Math.min(height, maxHeight), minHeight);
            
            // Cache check to avoid unnecessary updates
            const cacheKey = iframe.src + '-' + source;
            const cachedHeight = this.heightCache.get(cacheKey);
            if (cachedHeight && Math.abs(cachedHeight - safeHeight) < 5) return;
            
            try {
                iframe.style.height = safeHeight + 'px';
                iframe.style.minHeight = minHeight + 'px';
                iframe.style.overflow = 'hidden';
                iframe.style.border = 'none';
                iframe.style.display = 'block';
                iframe.style.width = '100%';
                
                iframe.offsetHeight; // Force reflow
                this.heightCache.set(cacheKey, safeHeight);
                
                console.log(`üçé Height set: ${source} ‚Üí ${safeHeight}px`);
                
                // Safari workaround: ensure height sticks
                setTimeout(() => {
                    if (iframe.style.height !== safeHeight + 'px') {
                        iframe.style.height = safeHeight + 'px';
                    }
                }, 50);
                
            } catch (error) {
                console.warn(`üçé Height error for ${source}:`, error);
            }
        },
        
        handleMessage(event) {
            try {
                if (!event.data || typeof event.data !== 'object') return;
                
                const { type, source, height, buttonId } = event.data;
                if (!source) return;
                
                const iframe = this.findIframeBySource(source);
                
                switch(type) {
                    case 'setIframeHeight':
                        if (iframe && height) {
                            this.setIframeHeight(iframe, height, source);
                        }
                        break;
                        
                    case 'iframeReady':
                        console.log(`üçé Iframe ready: ${source}`);
                        if (iframe && iframe.contentWindow) {
                            setTimeout(() => {
                                try {
                                    iframe.contentWindow.postMessage({
                                        type: 'init',
                                        browser: 'safari',
                                        timestamp: Date.now()
                                    }, '*');
                                } catch (e) {
                                    // Ignore postMessage errors
                                }
                            }, 100);
                        }
                        break;
                        
                    case 'buttonActivated':
                    case 'interaction':
                        // Trigger height recalculation after interactions
                        setTimeout(() => {
                            if (iframe && iframe.contentWindow) {
                                try {
                                    iframe.contentWindow.postMessage({
                                        type: 'requestHeight',
                                        timestamp: Date.now()
                                    }, '*');
                                } catch (e) {
                                    // Ignore postMessage errors
                                }
                            }
                        }, 150);
                        break;
                }
            } catch (error) {
                // Suppress errors to avoid console spam
            }
        }
    };
    
    // Set up message listener
    window.addEventListener("message", function(event) {
        safariIframeManager.handleMessage(event);
    }, false);
    
    // Configure iframes for Safari
    function setupSafariIframes() {
        const iframes = document.querySelectorAll('iframe');
        
        iframes.forEach(iframe => {
            if (safariIframeManager.processedIframes.has(iframe)) return;
            
            // Safari-specific attributes
            iframe.style.overflow = 'hidden';
            iframe.style.border = 'none';
            iframe.style.display = 'block';
            iframe.style.width = '100%';
            iframe.setAttribute('scrolling', 'no');
            iframe.setAttribute('frameborder', '0');
            
            // Lazy loading fix
            if (!iframe.src && iframe.getAttribute('data-src')) {
                iframe.src = iframe.getAttribute('data-src');
            }
            
            safariIframeManager.processedIframes.add(iframe);
        });
    }
    
    // Window resize handler
    function handleWindowResize() {
        const iframes = document.querySelectorAll('iframe');
        iframes.forEach(iframe => {
            if (iframe.contentWindow) {
                try {
                    iframe.contentWindow.postMessage({
                        type: 'resize',
                        width: window.innerWidth,
                        height: window.innerHeight
                    }, '*');
                } catch (e) {
                    // Ignore postMessage errors
                }
            }
        });
    }
    
    // Initialize Safari fixes
    function init() {
        setupSafariIframes();
        
        // Watch for new iframes
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'IFRAME' || (node.querySelectorAll && node.querySelectorAll('iframe').length > 0)) {
                                setTimeout(setupSafariIframes, 100);
                            }
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Debounced window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleWindowResize, 250);
        });
        
        console.log("üçé Safari iframe manager initialized");
    }
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Backup initialization
    setTimeout(init, 1000);
    
})();</pre>
        </div>
        
        <div class="step">
            <h3>üöÄ –®–∞–≥ 2: –î–æ–±–∞–≤—å—Ç–µ –≤ Figma Sites</h3>
            <ol>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –≤ Figma Sites</li>
                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</li>
                <li>–ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "Custom Code" –∏–ª–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥"</li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ —Å–µ–∫—Ü–∏—é &lt;head&gt; –∏–ª–∏ –ø–µ—Ä–µ–¥ &lt;/body&gt;</li>
                <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</li>
            </ol>
        </div>
        
        <div class="step success">
            <h3>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <p>–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ iframe –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –≤ Safari. –í –∫–æ–Ω—Å–æ–ª–∏ Safari –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</p>
            <ul>
                <li><code>üçé Safari iframe fix activated</code></li>
                <li><code>üçé Height set: support-html ‚Üí 450px</code></li>
                <li><code>üçé Iframe ready: tags-html</code></li>
            </ul>
        </div>
        
        <div class="step">
            <h3>üîç –û—Ç–ª–∞–¥–∫–∞</h3>
            <p>–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ Safari Developer Tools (‚åò‚å•I) –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.</p>
        </div>
    </div>

    <script>
        function copyCode() {
            const codeElement = document.getElementById('safari-code');
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const button = document.querySelector('.copy-btn');
            const originalText = button.textContent;
            button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            button.style.background = '#27ae60';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#3498db';
            }, 2000);
        }
    </script>
</body>
</html> 