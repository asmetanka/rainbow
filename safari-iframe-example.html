<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari iframe Example - Clean Version</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }
        
        .demo-section {
            padding: 16px 16px 120px 16px;
            position: relative;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        
        .demo-button {
            padding: 18px 24px;
            border-radius: 40px;
            font-weight: 500;
            font-size: 20px;
            cursor: pointer;
            border: none;
            outline: none;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 8px;
            transition: all 0.3s ease;
        }
        
        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .description-card {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 200;
            min-width: 280px;
            max-width: 400px;
        }
        
        .description-card.show {
            opacity: 1;
            visibility: visible;
            top: 70px;
        }
    </style>
</head>
<body>
    <div class="demo-section">
        <h1>Safari iframe Test</h1>
        <p>Click button to test height resizing in Safari:</p>
        
        <div class="button-container">
            <div class="button-wrapper">
                <button class="demo-button" id="test-button">Test Button</button>
                <div class="description-card" id="description-card">
                    <h3>Description Card</h3>
                    <p>This card should cause the iframe to resize in Safari.</p>
                    <p>In Chrome this works automatically, but Safari needs special handling.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const source = "safari-iframe-example";
        let isSendHeightBusy = false;

        // Auto-height script for iframe integration (Figma Sites)
        function sendHeight() {
            if (isSendHeightBusy) {
                console.log("sendHeight is busy, skipping call.");
                return;
            }
            isSendHeightBusy = true;

            const demoSection = document.querySelector('.demo-section');
            const body = document.body;
            const docElement = document.documentElement;
            let measuredHeight = 0;

            // Store original inline styles
            const originalDocStyleHeight = docElement.style.height || '';
            const originalBodyStyleHeight = body.style.height || '';
            const originalDemoSectionStyleHeight = demoSection ? (demoSection.style.height || '') : '';

            // Temporarily allow shrinking by setting relevant heights to auto
            docElement.style.height = 'auto';
            body.style.height = 'auto';
            if (demoSection) {
                demoSection.style.height = 'auto';
            }
            
            // Force browser reflow AFTER all 'auto' heights are set.
            docElement.offsetHeight; 

            // Measure the scrollHeight of the entire documentElement (HTML tag)
            measuredHeight = docElement.scrollHeight;
            
            // Restore original inline styles
            if (demoSection) {
                demoSection.style.height = originalDemoSectionStyleHeight;
            }
            body.style.height = originalBodyStyleHeight;
            docElement.style.height = originalDocStyleHeight;

            const finalHeight = Math.max(measuredHeight, 50);

            window.parent.postMessage({
                type: "setIframeHeight", 
                height: finalHeight,
                source: source
            }, "*");
            
            console.log("Height sent to parent:", finalHeight);

            setTimeout(() => {
                isSendHeightBusy = false;
            }, 150);
        }

        // Button click functionality
        document.getElementById('test-button').addEventListener('click', function() {
            const card = document.getElementById('description-card');
            card.classList.toggle('show');
            
            // Trigger height update after animation
            setTimeout(sendHeight, 350);
        });

        // Standard event listeners
        window.addEventListener('load', sendHeight);
        window.addEventListener('resize', sendHeight);

        // Initial height send
        if (document.readyState === 'complete') {
            sendHeight();
        } else {
            window.addEventListener('DOMContentLoaded', sendHeight);
        }
    </script>

    <!-- Safari-specific fixes inline -->
    <script>
        (function() {
            console.log("Safari iframe fix loaded");
            
            // Detect Safari
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (!isSafari) {
                console.log("Not Safari, skipping Safari-specific fixes");
                return;
            }
            
            console.log("Safari detected, applying fixes");
            
            // Safari-specific height calculation
            function getSafariHeight() {
                const body = document.body;
                const html = document.documentElement;
                
                // Multiple height calculation methods for Safari
                const heights = [
                    body.scrollHeight,
                    body.offsetHeight,
                    html.scrollHeight,
                    html.offsetHeight,
                    html.clientHeight
                ];
                
                // Safari sometimes reports 0 or very small heights initially
                const validHeights = heights.filter(h => h > 10);
                const maxHeight = Math.max(...validHeights);
                
                // Additional check for visible content
                const allElements = document.querySelectorAll('*');
                let maxElementBottom = 0;
                
                for (let element of allElements) {
                    if (element.offsetParent !== null) { // Only visible elements
                        const rect = element.getBoundingClientRect();
                        const elementBottom = rect.bottom + window.pageYOffset;
                        maxElementBottom = Math.max(maxElementBottom, elementBottom);
                    }
                }
                
                // Use the larger of the calculated heights
                return Math.max(maxHeight, maxElementBottom, 100); // Minimum 100px
            }
            
            // Enhanced sendHeight function for Safari
            function safariSendHeight() {
                if (window.isSendHeightBusy) {
                    console.log("Safari fix - sendHeight is busy, skipping call.");
                    return;
                }
                window.isSendHeightBusy = true;
                
                // Force layout recalculation in Safari
                document.body.style.display = 'none';
                document.body.offsetHeight; // Trigger reflow
                document.body.style.display = '';
                
                // Small delay to let Safari settle
                setTimeout(() => {
                    const height = getSafariHeight();
                    
                    // Add buffer for Safari (it tends to cut off content)
                    const safariBuffer = 20;
                    const finalHeight = height + safariBuffer;
                    
                    window.parent.postMessage({
                        type: "setIframeHeight",
                        height: finalHeight,
                        source: window.source || "safari-iframe",
                        safari: true // Mark as Safari-specific
                    }, "*");
                    
                    console.log("Safari - Height sent to parent:", finalHeight);
                    
                    setTimeout(() => {
                        window.isSendHeightBusy = false;
                    }, 200); // Longer delay for Safari
                }, 100);
            }
            
            // Override the global sendHeight function for Safari
            window.sendHeight = safariSendHeight;
            
            // Safari-specific click handler with delayed height update
            document.addEventListener('click', function(event) {
                const target = event.target;
                const isButton = target.classList.contains('demo-button') || 
                                target.closest('.demo-button');
                
                if (isButton) {
                    console.log("Safari - Button interaction detected");
                    // Multiple delayed updates to catch animation states
                    setTimeout(safariSendHeight, 100);  // Quick initial update
                    setTimeout(safariSendHeight, 350);  // After fade-out
                    setTimeout(safariSendHeight, 650);  // After fade-in
                    setTimeout(safariSendHeight, 1000); // Final safety check
                }
            });
            
            // Safari periodic check
            setInterval(safariSendHeight, 2000);
            
            console.log("Safari iframe fixes applied successfully");
        })();
    </script>
</body>
</html> 